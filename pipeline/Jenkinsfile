pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws_access_key_id')
        AWS_SECRET_ACCESS_KEY = credentials('aws_secret_access_key')
    }

    options {
        ansiColor('xterm')
    }

    stages {
        stage('Booting up the pipline') {
            steps {
                sh 'echo "Hello Shubham, ready for your deployment. Let\'s go"'
            }
        }
        stage('Deploy infra') {
            steps {
                dir('wearify-infra') {
                    echo 'Deploying your wearify app infrastructure...'
                    sh 'terraform init'
                    sh 'terraform apply --auto-approve'
                }
            }
        }
        stage('Setup k8s cluster') {
            steps{
            dir('wearify-infra') {
                    script {
                        def wearify_master_ip_addr = sh(script: "terraform output -raw wearify_master_node_ipv4_addr", returnStdout: true).trim()
                        def wearify_key_path = sh(script: "terraform output -raw wearify_key_location", returnStdout: true).trim()

                        echo "Setting up Wearify Master node at IP: ${wearify_master_ip_addr}"

                        sh """
                        ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ./wearify_keys/wearify_keypair.pem ubuntu@${wearify_master_ip_addr} ./master_node_setup.sh
                        """
                        
                        echo "Setting up Wearify Worker nodes"
                        sh """
                        i=1
                        while IFS= read -r worker_ip; do
                            echo "Setting up Worker \$i at \$worker_ip"
                            ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ./wearify_keys/wearify_keypair.pem ubuntu@${wearify_master_ip_addr} \\
                                "ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ~/.ssh/wearify_keypair.pem ubuntu@\${worker_ip} \\"bash /home/ubuntu/worker_node_setup.sh \${i}\\""
                            i=\$((i+1))
                        done < worker_private_ips.txt
                        """

                        sh """
                        ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ./wearify_keys/wearify_keypair.pem ubuntu@${wearify_master_ip_addr} kubectl get nodes
                        """
                    }
            }
            }
        }
    }
}